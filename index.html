<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes" />
  <title>Sistem Inventaris SD Â· Lazuardi (ImgBB)</title>

  <!-- FIREBASE SDK 10.12.2 -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- FONTS, ICONS, CHARTS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ========== RESET & VARIABLES ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #0284c7;
      --primary-dark: #0369a1;
      --primary-light: #e0f2fe;
      --secondary: #f59e0b;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #0f172a;
      --gray: #64748b;
      --light: #f8fafc;
      --border: #e2e8f0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #f1f5f9;
      color: var(--dark);
      line-height: 1.5;
    }

    /* ========== TOAST NOTIFICATION ========== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background: white;
      border-radius: 1rem;
      padding: 1rem 1.5rem;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 300px;
      max-width: 450px;
      animation: slideIn 0.3s ease;
      border-left: 5px solid;
    }

    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--danger); }
    .toast.warning { border-left-color: var(--warning); }
    .toast.info { border-left-color: var(--primary); }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* ========== LOADING OVERLAY ========== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(5px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      flex-direction: column;
      gap: 1rem;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid var(--primary-light);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ========== LOGIN PAGE ========== */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, #e0f2fe 0%, #bae6fd 100%);
      padding: 1.5rem;
    }

    .glass-card {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.5);
      border-radius: 2rem;
      padding: 2.5rem 2rem;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
    }

    .glass-card h2 {
      font-weight: 800;
      font-size: 1.8rem;
      color: #075985;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .input-group {
      margin-bottom: 1.25rem;
    }

    .input-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #334155;
      margin-bottom: 0.4rem;
    }

    .input-field {
      width: 100%;
      padding: 0.9rem 1.2rem;
      background: white;
      border: 2px solid var(--border);
      border-radius: 1.2rem;
      font-size: 1rem;
      transition: 0.2s ease;
      outline: none;
    }

    .input-field:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(2,132,199,0.15);
    }

    .btn-login {
      width: 100%;
      padding: 0.9rem;
      background: linear-gradient(115deg, #0369a1, #0284c7);
      border: none;
      border-radius: 1.5rem;
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      cursor: pointer;
      transition: 0.2s;
    }

    /* ========== LAYOUT UTAMA ========== */
    .layout {
      display: none;
      min-height: 100vh;
    }

    .sidebar {
      position: fixed;
      width: 280px;
      height: 100vh;
      background: linear-gradient(170deg, #0c4a6e, #075985);
      padding: 2rem 1.5rem;
      color: white;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 20px rgba(0,0,0,0.08);
      transition: all 0.3s;
      z-index: 100;
    }

    .sidebar h2 {
      font-size: 1.6rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 2.5rem;
      border-bottom: 2px solid rgba(255,255,255,0.15);
      padding-bottom: 1.5rem;
    }

    .menu {
      flex: 1;
    }

    .menu a {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      color: rgba(255,255,255,0.85);
      text-decoration: none;
      padding: 0.9rem 1.2rem;
      border-radius: 1.2rem;
      margin-bottom: 0.4rem;
      font-weight: 550;
      transition: 0.2s;
      cursor: pointer;
    }

    .menu a i { width: 1.5rem; text-align: center; }
    .menu a:hover, .menu a.active { background: rgba(255,255,255,0.15); color: white; }

    .user-info {
      background: rgba(255,255,255,0.08);
      border-radius: 1.2rem;
      padding: 1rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .content {
      margin-left: 280px;
      padding: 2rem 2.5rem;
      width: calc(100% - 280px);
    }

    /* ========== CARD MODERN ========== */
    .card {
      background: white;
      border-radius: 1.75rem;
      padding: 1.8rem 2rem;
      box-shadow: 0 10px 30px -5px rgba(0,0,0,0.03);
      border: 1px solid rgba(255,255,255,0.8);
      margin-bottom: 2rem;
    }

    .card h3 {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 1.3rem;
      font-weight: 700;
      color: #075985;
      margin-bottom: 1.5rem;
      border-bottom: 3px solid var(--primary-light);
      padding-bottom: 0.8rem;
    }

    /* ========== FORM ELEMENTS ========== */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    input, select, textarea {
      background: #f8fafc;
      border: 2px solid var(--border);
      border-radius: 1rem;
      padding: 0.9rem 1.2rem;
      width: 100%;
      font-size: 0.98rem;
      transition: 0.15s;
      outline: none;
    }

    input:focus, select:focus {
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 4px #bae6fd;
    }

    /* ========== BUTTONS ========== */
    .btn, .btn-primary, .btn-warning, .btn-danger, .btn-success {
      border: none;
      padding: 0.8rem 1.8rem;
      border-radius: 2rem;
      font-weight: 600;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      transition: 0.2s;
      cursor: pointer;
      color: white;
    }

    .btn-primary { background: var(--primary); }
    .btn-success { background: var(--success); }
    .btn-warning { background: var(--warning); }
    .btn-danger { background: var(--danger); }

    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
    .btn-success:hover { background: #0b9e6e; transform: translateY(-2px); }
    .btn-warning:hover { background: #d97706; transform: translateY(-2px); }
    .btn-danger:hover { background: #b91c1c; transform: translateY(-2px); }

    /* ========== TABLES ========== */
    .table-responsive {
      overflow-x: auto;
      border-radius: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f0f9ff;
      color: #075985;
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      padding: 1rem;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    tr:hover td { background: #fafdff; }

    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 2rem;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .badge-success { background: #d1fae5; color: #065f46; }
    .badge-warning { background: #fef3c7; color: #92400e; }

    /* ========== STATS DASHBOARD ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 10px 25px -10px rgba(0,0,0,0.02);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(145deg, var(--primary-light), #bae6fd);
      border-radius: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: var(--primary-dark);
    }

    .stat-content h4 { font-size: 0.9rem; color: var(--gray); margin-bottom: 0.2rem; }
    .stat-content span { font-size: 2.2rem; font-weight: 800; color: var(--dark); }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--gray);
    }
    .empty-state i { font-size: 4rem; margin-bottom: 1rem; color: var(--primary-light); }

    /* ========== IMAGE PREVIEW ========== */
    .img-preview {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 1rem;
      border: 3px solid white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .img-preview:hover { transform: scale(1.1); }

    .file-label {
      background: #f1f5f9;
      padding: 0.8rem 1.5rem;
      border-radius: 2rem;
      display: inline-block;
      cursor: pointer;
      border: 2px dashed #94a3b8;
      transition: all 0.3s;
    }
    .file-label:hover { background: #e2e8f0; border-color: var(--primary); }

    /* ========== HIDDEN ========== */
    .hidden { display: none !important; }

    /* ========== MOBILE RESPONSIVE ========== */
    @media (max-width: 768px) {
      .sidebar { width: 100px; padding: 1rem; }
      .sidebar h2 span, .menu a span, .user-info span { display: none; }
      .content { margin-left: 100px; width: calc(100% - 100px); padding: 1rem; }
      .form-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- ========== TOAST NOTIFICATION ========== -->
<div id="toastContainer" class="toast-container"></div>

<!-- ========== LOADING OVERLAY ========== -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner"></div>
  <p style="color: var(--primary); font-weight: 600;">Sedang memproses...</p>
</div>

<!-- ========== LOGIN PAGE ========== -->
<div id="loginPage" class="login-container">
  <div class="glass-card">
    <h2><i class="fas fa-school"></i> Lazuardi</h2>
    <p style="color: #164863; margin-bottom: 1.8rem; font-weight: 500;">Sistem Inventaris Sekolah</p>
    
    <div class="input-group">
      <label><i class="fas fa-user"></i> Username</label>
      <input type="text" id="username" class="input-field" placeholder="admin" value="admin">
    </div>
    <div class="input-group">
      <label><i class="fas fa-lock"></i> Password</label>
      <input type="password" id="password" class="input-field" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value="lazuardi">
    </div>
    <div class="input-group">
      <label><i class="fas fa-user-tag"></i> Role</label>
      <select id="role" class="input-field">
        <option value="admin">Admin</option>
        <option value="guru">Guru</option>
      </select>
    </div>

    <button class="btn-login" onclick="login()">
      <i class="fas fa-arrow-right-to-bracket"></i> Masuk
    </button>
    <div id="loginError" style="color: #b91c1c; margin-top: 1rem; display: none;">
      <i class="fas fa-circle-exclamation"></i> Username/password salah
    </div>
  </div>
</div>

<!-- ========== APLIKASI UTAMA ========== -->
<div class="layout" id="app">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2><i class="fas fa-cubes"></i> <span>SD Lazuardi</span></h2>
    
    <div id="userInfo" class="user-info">
      <i class="fas fa-user-circle"></i> <span id="userName">Admin</span><br>
      <small id="userRole" style="opacity: 0.8;">Administrator</small>
    </div>

    <div class="menu">
      <a onclick="showPage('dashboard')" class="active" id="menu-dashboard">
        <i class="fas fa-chart-pie"></i> <span>Dashboard</span>
      </a>
      <a onclick="showPage('barang')" id="menu-barang">
        <i class="fas fa-boxes"></i> <span>Data Barang</span>
      </a>
      <a onclick="showPage('pinjam')" id="menu-pinjam">
        <i class="fas fa-hand-holding"></i> <span>Peminjaman</span>
      </a>
      <a onclick="showPage('laporan')" id="menu-laporan">
        <i class="fas fa-file-alt"></i> <span>Laporan</span>
      </a>
      <a onclick="logout()" style="background: rgba(239,68,68,0.15);">
        <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
      </a>
    </div>
  </div>

  <!-- CONTENT AREA -->
  <div class="content">

    <!-- ========== DASHBOARD ========== -->
    <div id="dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-box"></i></div>
          <div class="stat-content">
            <h4>Total Barang</h4>
            <span id="totalBarang">0</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-hand-holding"></i></div>
          <div class="stat-content">
            <h4>Dipinjam</h4>
            <span id="totalPinjam">0</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
          <div class="stat-content">
            <h4>Tersedia</h4>
            <span id="totalTersedia">0</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
          <div class="stat-content">
            <h4>Stok Menipis</h4>
            <span id="totalMenipis">0</span>
          </div>
        </div>
      </div>

      <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <div class="card">
          <h3><i class="fas fa-chart-bar"></i> Grafik Stok Barang</h3>
          <canvas id="stockChart" style="width:100%; height:250px;"></canvas>
        </div>
        <div class="card">
          <h3><i class="fas fa-clock"></i> Peminjaman Terbaru</h3>
          <div id="recentPinjam" style="max-height: 250px; overflow-y: auto;">
            <!-- dynamic content -->
          </div>
        </div>
      </div>
    </div>

    <!-- ========== DATA BARANG DENGAN IMGBB ========== -->
    <div id="barang" class="hidden">
      <!-- FORM TAMBAH BARANG -->
      <div class="card">
        <h3><i class="fas fa-plus-circle"></i> Tambah Barang</h3>
        <div class="form-grid">
          <input type="text" id="nama" placeholder="Nama Barang">
          <input type="number" id="jumlah" placeholder="Jumlah Stok">
          <select id="kategori">
            <option value="">Pilih Kategori</option>
            <option value="Elektronik">Elektronik</option>
            <option value="Perabot">Perabot</option>
            <option value="ATK">ATK</option>
            <option value="Lainnya">Lainnya</option>
          </select>
          <input type="number" id="stokMinimum" placeholder="Stok Minimum" value="5">
        </div>
        
        <!-- FILE UPLOAD DENGAN PREVIEW -->
        <div style="margin: 1.5rem 0;">
          <label for="gambar" class="file-label">
            <i class="fas fa-cloud-upload-alt"></i> 
            <span id="fileName">Pilih Gambar</span>
          </label>
          <input type="file" id="gambar" accept="image/*" style="display: none;" onchange="previewImage(this)">
          <div id="imagePreview" style="margin-top: 1rem; display: none;">
            <img src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 1rem; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
          </div>
        </div>

        <button class="btn-primary" onclick="tambahBarang()">
          <i class="fas fa-save"></i> Simpan Barang
        </button>
      </div>

      <!-- SEARCH & FILTER -->
      <div class="card">
        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
          <div style="flex: 1;">
            <input type="text" id="searchBarang" placeholder="ðŸ” Cari nama/kode barang..." onkeyup="filterBarang()">
          </div>
          <div style="width: 200px;">
            <select id="filterKategori" onchange="filterBarang()">
              <option value="">Semua Kategori</option>
              <option value="Elektronik">Elektronik</option>
              <option value="Perabot">Perabot</option>
              <option value="ATK">ATK</option>
              <option value="Lainnya">Lainnya</option>
            </select>
          </div>
          <div>
            <select id="sortBarang" onchange="filterBarang()">
              <option value="nama">Urut: Nama</option>
              <option value="jumlah">Urut: Stok</option>
              <option value="kode">Urut: Kode</option>
            </select>
          </div>
        </div>
      </div>

      <!-- TABEL BARANG -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3><i class="fas fa-list"></i> Daftar Barang</h3>
          <div>
            <button class="btn-success" onclick="exportExcel()" style="margin-right: 0.5rem;">
              <i class="fas fa-file-excel"></i> Excel
            </button>
            <button class="btn-primary" onclick="cetakPDF()">
              <i class="fas fa-file-pdf"></i> PDF
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Kode</th>
                <th>Gambar</th>
                <th>Nama</th>
                <th>Kategori</th>
                <th>Stok</th>
                <th>Min</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="tabelBarang"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ========== PEMINJAMAN & PENGEMBALIAN ========== -->
    <div id="pinjam" class="hidden">
      <!-- FORM PEMINJAMAN -->
      <div class="card">
        <h3><i class="fas fa-hand-holding-heart"></i> Form Peminjaman</h3>
        <div class="form-grid">
          <input type="text" id="peminjam" placeholder="Nama Peminjam">
          <select id="barangSelect">
            <option value="">Pilih Barang</option>
          </select>
          <input type="number" id="jumlahPinjam" placeholder="Jumlah">
          <input type="date" id="tanggalPinjam" value="">
        </div>
        <button class="btn-warning" onclick="pinjamBarang()" style="margin-top: 1rem;">
          <i class="fas fa-check-circle"></i> Pinjam Barang
        </button>
      </div>

      <!-- DAFTAR PEMINJAMAN AKTIF -->
      <div class="card">
        <h3><i class="fas fa-clock"></i> Peminjaman Aktif</h3>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Peminjam</th>
                <th>Barang</th>
                <th>Jumlah</th>
                <th>Tanggal</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="tabelPinjamAktif"></tbody>
          </table>
        </div>
      </div>

      <!-- RIWAYAT PEMINJAMAN -->
      <div class="card">
        <h3><i class="fas fa-history"></i> Riwayat Peminjaman</h3>
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Peminjam</th>
                <th>Barang</th>
                <th>Jumlah</th>
                <th>Tanggal</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="tabelRiwayat"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ========== LAPORAN ========== -->
    <div id="laporan" class="hidden">
      <div class="card">
        <h3><i class="fas fa-file-export"></i> Export Laporan</h3>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <button class="btn-success" onclick="exportExcel()">
            <i class="fas fa-file-excel"></i> Export Excel
          </button>
          <button class="btn-primary" onclick="cetakPDF()">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
        </div>
      </div>

      <div class="card">
        <h3><i class="fas fa-chart-line"></i> Statistik Peminjaman</h3>
        <canvas id="pinjamChart" style="width:100%; height:300px;"></canvas>
      </div>
    </div>

  </div> <!-- end content -->
</div> <!-- end app -->

<script>
  // ========== FIREBASE CONFIG ==========
  const firebaseConfig = {
    apiKey: "AIzaSyAVeXYR1sI6YC9xOVhlBSbf0RFMr9Ams1g",
    authDomain: "inventaris-sd.firebaseapp.com",
    projectId: "inventaris-sd",
    storageBucket: "inventaris-sd.firebasestorage.app",
    messagingSenderId: "421661627652",
    appId: "1:421661627652:web:9ae755b3a997b8544e6c51",
    measurementId: "G-SVNDR0ZRW6"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ========== GLOBAL VARIABLES ==========
  let currentUser = null;
  let currentRole = 'admin';
  let barangData = [];
  let pinjamData = [];

  // ========== IMGBB API KEY ==========
  const IMGBB_API_KEY = '0037c299ecb5215d3e142b7993842a11';

  // ========== TOAST NOTIFICATION ==========
  function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'fa-check-circle';
    if (type === 'error') icon = 'fa-exclamation-circle';
    if (type === 'warning') icon = 'fa-exclamation-triangle';
    if (type === 'info') icon = 'fa-info-circle';
    
    toast.innerHTML = `
      <i class="fas ${icon}"></i>
      <span style="flex:1; font-weight:500;">${message}</span>
      <button onclick="this.parentElement.remove()" style="background:none; border:none; cursor:pointer; color:var(--gray);">
        <i class="fas fa-times"></i>
      </button>
    `;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
  }

  // ========== LOADING ==========
  function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
  }
  function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
  }

  // ========== LOGIN ==========
  function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;
    const loginError = document.getElementById('loginError');

    if (username === 'admin' && password === 'lazuardi') {
      currentRole = role;
      localStorage.setItem('login', 'true');
      localStorage.setItem('role', currentRole);
      
      document.getElementById('userName').innerHTML = username;
      document.getElementById('userRole').innerHTML = role === 'admin' ? 'Administrator' : 'Guru';
      
      showToast(`Selamat datang, ${username}!`, 'success');
      cekLogin();
    } else {
      loginError.style.display = 'block';
    }
  }

  // ========== LOGOUT ==========
  function logout() {
    localStorage.removeItem('login');
    localStorage.removeItem('role');
    location.reload();
  }

  // ========== CEK LOGIN ==========
  function cekLogin() {
    if (localStorage.getItem('login') === 'true') {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      currentRole = localStorage.getItem('role') || 'admin';
      loadData();
      initCharts();
      
      // Set default date
      const today = new Date().toISOString().split('T')[0];
      if (document.getElementById('tanggalPinjam')) {
        document.getElementById('tanggalPinjam').value = today;
      }
    }
  }

  // ========== SHOW PAGE ==========
  function showPage(pageId) {
    ['dashboard', 'barang', 'pinjam', 'laporan'].forEach(p => 
      document.getElementById(p).classList.add('hidden')
    );
    document.getElementById(pageId).classList.remove('hidden');
    
    document.querySelectorAll('.menu a').forEach(el => el.classList.remove('active'));
    document.getElementById(`menu-${pageId}`).classList.add('active');
  }

  // ========== PREVIEW GAMBAR ==========
  function previewImage(input) {
    const fileName = document.getElementById('fileName');
    const preview = document.getElementById('imagePreview');
    const previewImg = preview.querySelector('img');
    
    if (input.files && input.files[0]) {
      fileName.innerHTML = input.files[0].name;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(input.files[0]);
    } else {
      fileName.innerHTML = 'Pilih Gambar';
      preview.style.display = 'none';
    }
  }

  // ========== UPLOAD KE IMGBB ==========
  async function uploadToImgBB(file) {
    const formData = new FormData();
    formData.append('image', file);
    
    try {
      const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      if (data.success) {
        return {
          url: data.data.url,
          thumb: data.data.thumb.url,
          medium: data.data.medium.url,
          delete_url: data.data.delete_url
        };
      } else {
        throw new Error(data.error?.message || 'Upload gagal');
      }
    } catch (error) {
      console.error('Error upload ke ImgBB:', error);
      throw error;
    }
  }

  // ========== TAMBAH BARANG ==========
  async function tambahBarang() {
    const nama = document.getElementById('nama').value;
    const jumlah = document.getElementById('jumlah').value;
    const kategori = document.getElementById('kategori').value;
    const stokMinimum = document.getElementById('stokMinimum').value;
    const file = document.getElementById('gambar').files[0];

    if (!nama || !jumlah || !kategori || !file) {
      showToast('Lengkapi semua data!', 'error');
      return;
    }

    showLoading();

    try {
      showToast('ðŸ“¤ Mengupload gambar...', 'info');
      const imageData = await uploadToImgBB(file);
      
      const snapshot = await db.collection('barang').get();
      const kode = 'SD-' + String(snapshot.size + 1).padStart(3, '0');
      
      await db.collection('barang').add({
        kode: kode,
        nama: nama,
        jumlah: parseInt(jumlah),
        kategori: kategori,
        stokMinimum: parseInt(stokMinimum) || 5,
        gambar: imageData.url,
        thumbnail: imageData.thumb,
        imgbb_delete_url: imageData.delete_url,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      showToast('âœ… Barang berhasil ditambahkan!', 'success');
      
      document.getElementById('nama').value = '';
      document.getElementById('jumlah').value = '';
      document.getElementById('kategori').value = '';
      document.getElementById('gambar').value = '';
      document.getElementById('fileName').innerHTML = 'Pilih Gambar';
      document.getElementById('stokMinimum').value = '5';
      document.getElementById('imagePreview').style.display = 'none';

    } catch (error) {
      showToast('âŒ Gagal: ' + error.message, 'error');
    }

    hideLoading();
  }

  // ========== HAPUS BARANG ==========
  async function hapusBarang(id, imgbbDeleteUrl) {
    if (!confirm('Yakin ingin menghapus barang ini?')) return;
    
    showLoading();
    
    try {
      if (imgbbDeleteUrl) {
        try {
          await fetch(imgbbDeleteUrl);
        } catch (e) {
          console.log('Gagal hapus gambar di ImgBB:', e);
        }
      }
      
      await db.collection('barang').doc(id).delete();
      showToast('âœ… Barang berhasil dihapus!', 'success');
    } catch (error) {
      showToast('âŒ Gagal: ' + error.message, 'error');
    }
    
    hideLoading();
  }

  // ========== EDIT BARANG ==========
  async function editBarang(id) {
    const namaBaru = prompt('Masukkan nama barang baru:');
    if (!namaBaru) return;
    
    showLoading();
    try {
      await db.collection('barang').doc(id).update({
        nama: namaBaru
      });
      showToast('âœ… Nama barang berhasil diupdate!', 'success');
    } catch (error) {
      showToast('âŒ Gagal: ' + error.message, 'error');
    }
    hideLoading();
  }

  // ========== PINJAM BARANG ==========
  async function pinjamBarang() {
    const barangId = document.getElementById('barangSelect').value;
    const peminjam = document.getElementById('peminjam').value;
    const jumlah = parseInt(document.getElementById('jumlahPinjam').value);
    const tanggal = document.getElementById('tanggalPinjam').value;

    if (!barangId || !peminjam || !jumlah) {
      showToast('Lengkapi data peminjaman!', 'error');
      return;
    }

    showLoading();

    try {
      const barangRef = db.collection('barang').doc(barangId);
      const barangDoc = await barangRef.get();
      const barang = barangDoc.data();

      if (jumlah > barang.jumlah) {
        hideLoading();
        showToast('Stok tidak mencukupi!', 'error');
        return;
      }

      await barangRef.update({
        jumlah: barang.jumlah - jumlah
      });

      await db.collection('pinjam').add({
        barangId,
        barangNama: barang.nama,
        peminjam,
        jumlah,
        tanggal,
        status: 'aktif',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      showToast('âœ… Peminjaman berhasil!', 'success');
      
      document.getElementById('peminjam').value = '';
      document.getElementById('jumlahPinjam').value = '';

    } catch (error) {
      showToast('âŒ Gagal: ' + error.message, 'error');
    }

    hideLoading();
  }

  // ========== KEMBALIKAN BARANG ==========
  async function kembalikanBarang(pinjamId, barangId, jumlah) {
    if (!confirm('Konfirmasi pengembalian barang?')) return;

    showLoading();

    try {
      await db.collection('pinjam').doc(pinjamId).update({
        status: 'kembali',
        tanggalKembali: new Date().toISOString().split('T')[0]
      });

      await db.collection('barang').doc(barangId).update({
        jumlah: firebase.firestore.FieldValue.increment(jumlah)
      });

      showToast('âœ… Barang berhasil dikembalikan!', 'success');
    } catch (error) {
      showToast('âŒ Gagal: ' + error.message, 'error');
    }

    hideLoading();
  }

  // ========== FILTER & SEARCH BARANG ==========
  function filterBarang() {
    const search = document.getElementById('searchBarang').value.toLowerCase();
    const kategori = document.getElementById('filterKategori').value;
    const sort = document.getElementById('sortBarang').value;
    
    let filtered = [...barangData];
    
    if (search) {
      filtered = filtered.filter(b => 
        b.nama?.toLowerCase().includes(search) || 
        b.kode?.toLowerCase().includes(search)
      );
    }
    
    if (kategori) {
      filtered = filtered.filter(b => b.kategori === kategori);
    }
    
    filtered.sort((a, b) => {
      if (sort === 'nama') return (a.nama || '').localeCompare(b.nama || '');
      if (sort === 'jumlah') return (b.jumlah || 0) - (a.jumlah || 0);
      return (a.kode || '').localeCompare(b.kode || '');
    });
    
    renderTabelBarang(filtered);
  }

  // ========== RENDER TABEL BARANG ==========
  function renderTabelBarang(data) {
    const tbody = document.getElementById('tabelBarang');
    
    if (data.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="8">
            <div class="empty-state">
              <i class="fas fa-box-open"></i>
              <h4>Belum ada data barang</h4>
              <p style="color: var(--gray);">Tambah barang baru untuk memulai</p>
            </div>
          </td>
        </tr>
      `;
      return;
    }
    
    tbody.innerHTML = data.map(b => {
      const statusStok = b.jumlah <= (b.stokMinimum || 5) ? 'warning' : 'success';
      const statusText = b.jumlah <= (b.stokMinimum || 5) ? 'Stok Menipis' : 'Tersedia';
      const badgeClass = statusStok === 'warning' ? 'badge-warning' : 'badge-success';
      
      return `<tr>
        <td><span style="background:var(--primary-light); padding:0.3rem 0.7rem; border-radius:2rem; font-weight:600;">${b.kode || '-'}</span></td>
        <td>
          <img src="${b.thumbnail || b.gambar || 'https://via.placeholder.com/50'}" 
               class="img-preview" 
               onclick="window.open('${b.gambar}', '_blank')">
        </td>
        <td><strong>${b.nama || '-'}</strong></td>
        <td>${b.kategori || '-'}</td>
        <td><span style="font-weight:700;">${b.jumlah || 0}</span></td>
        <td>${b.stokMinimum || 5}</td>
        <td><span class="badge ${badgeClass}">${statusText}</span></td>
        <td>
          ${currentRole === 'admin' ? `
            <button class="btn-primary" style="padding:0.4rem 1rem;" onclick="editBarang('${b.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-danger" style="padding:0.4rem 1rem;" onclick="hapusBarang('${b.id}', '${b.imgbb_delete_url || ''}')">
              <i class="fas fa-trash"></i>
            </button>
          ` : `
            <span class="badge badge-success">View only</span>
          `}
        </td>
      </tr>`;
    }).join('');
  }

  // ========== LOAD DATA ==========
  function loadData() {
    // Load barang
    db.collection('barang').onSnapshot(snapshot => {
      barangData = [];
      let totalStok = 0;
      let stokMenipis = 0;
      
      snapshot.forEach(doc => {
        const b = { id: doc.id, ...doc.data() };
        barangData.push(b);
        totalStok += b.jumlah || 0;
        if (b.jumlah <= (b.stokMinimum || 5)) stokMenipis++;
      });
      
      document.getElementById('totalBarang').innerText = snapshot.size;
      document.getElementById('totalTersedia').innerText = totalStok;
      document.getElementById('totalMenipis').innerText = stokMenipis;
      
      filterBarang();
      
      const select = document.getElementById('barangSelect');
      if (select) {
        select.innerHTML = '<option value="">Pilih Barang</option>';
        barangData.filter(b => b.jumlah > 0).forEach(b => {
          select.innerHTML += `<option value="${b.id}">${b.nama} (Stok: ${b.jumlah})</option>`;
        });
      }
      
      updateDashboardCharts();
    });

    // Load peminjaman
    db.collection('pinjam').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
      pinjamData = [];
      let totalAktif = 0;
      
      snapshot.forEach(doc => {
        const p = { id: doc.id, ...doc.data() };
        pinjamData.push(p);
        if (p.status === 'aktif') totalAktif++;
      });
      
      document.getElementById('totalPinjam').innerText = totalAktif;
      
      // Tabel peminjaman aktif
      const aktifTbody = document.getElementById('tabelPinjamAktif');
      const aktif = pinjamData.filter(p => p.status === 'aktif');
      
      if (aktif.length === 0) {
        aktifTbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><i class="fas fa-check-circle"></i><p>Tidak ada peminjaman aktif</p></div></td></tr>`;
      } else {
        aktifTbody.innerHTML = aktif.map(p => `
          <tr>
            <td><i class="fas fa-user"></i> ${p.peminjam}</td>
            <td>${p.barangNama}</td>
            <td><span class="badge badge-warning">${p.jumlah}</span></td>
            <td>${p.tanggal || '-'}</td>
            <td><span class="badge badge-warning">Aktif</span></td>
            <td>
              <button class="btn-success" style="padding:0.4rem 1rem;" onclick="kembalikanBarang('${p.id}','${p.barangId}',${p.jumlah})">
                <i class="fas fa-undo"></i> Kembali
              </button>
            </td>
          </tr>
        `).join('');
      }
      
      // Riwayat peminjaman
      const riwayatTbody = document.getElementById('tabelRiwayat');
      const riwayat = pinjamData.filter(p => p.status === 'kembali').slice(0, 20);
      
      if (riwayat.length === 0) {
        riwayatTbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><i class="fas fa-history"></i><p>Belum ada riwayat</p></div></td></tr>`;
      } else {
        riwayatTbody.innerHTML = riwayat.map(p => `
          <tr>
            <td>${p.peminjam}</td>
            <td>${p.barangNama}</td>
            <td>${p.jumlah}</td>
            <td>${p.tanggal || '-'}</td>
            <td><span class="badge badge-success">Kembali</span></td>
          </tr>
        `).join('');
      }
      
      // Recent pinjam untuk dashboard
      const recentDiv = document.getElementById('recentPinjam');
      if (recentDiv) {
        recentDiv.innerHTML = pinjamData.slice(0, 5).map(p => `
          <div style="display:flex; justify-content:space-between; padding:0.8rem; border-bottom:1px solid var(--border);">
            <span><strong>${p.peminjam}</strong> - ${p.barangNama}</span>
            <span class="badge ${p.status === 'aktif' ? 'badge-warning' : 'badge-success'}">${p.status}</span>
          </div>
        `).join('');
      }
      
      updatePinjamChart();
    });
  }

  // ========== CHARTS ==========
  let stockChart = null;
  let pinjamChart = null;

  function initCharts() {
    const ctx = document.getElementById('stockChart')?.getContext('2d');
    if (ctx) {
      stockChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'Stok Barang', data: [], backgroundColor: '#0284c7' }] }
      });
    }
    
    const pinjamCtx = document.getElementById('pinjamChart')?.getContext('2d');
    if (pinjamCtx) {
      pinjamChart = new Chart(pinjamCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Peminjaman', data: [], borderColor: '#0284c7', tension: 0.4 }] }
      });
    }
  }

  function updateDashboardCharts() {
    if (stockChart && barangData.length > 0) {
      const top5 = barangData.slice(0, 5);
      stockChart.data.labels = top5.map(b => b.nama);
      stockChart.data.datasets[0].data = top5.map(b => b.jumlah);
      stockChart.update();
    }
  }

  function updatePinjamChart() {
    if (pinjamChart && pinjamData.length > 0) {
      const pinjamPerHari = {};
      pinjamData.forEach(p => {
        const date = p.tanggal || new Date().toISOString().split('T')[0];
        pinjamPerHari[date] = (pinjamPerHari[date] || 0) + 1;
      });
      
      const dates = Object.keys(pinjamPerHari).sort().slice(-7);
      pinjamChart.data.labels = dates;
      pinjamChart.data.datasets[0].data = dates.map(d => pinjamPerHari[d] || 0);
      pinjamChart.update();
    }
  }

  // ========== EXPORT EXCEL ==========
  function exportExcel() {
    try {
      const wsData = [
        ['Kode', 'Nama Barang', 'Kategori', 'Stok', 'Stok Minimum', 'Status']
      ];
      
      barangData.forEach(b => {
        wsData.push([
          b.kode,
          b.nama,
          b.kategori || '-',
          b.jumlah,
          b.stokMinimum || 5,
          b.jumlah <= (b.stokMinimum || 5) ? 'Stok Menipis' : 'Tersedia'
        ]);
      });
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, 'Inventaris');
      XLSX.writeFile(wb, `inventaris_sd_${new Date().getTime()}.xlsx`);
      
      showToast('âœ… Export Excel berhasil!', 'success');
    } catch (error) {
      showToast('âŒ Gagal export: ' + error.message, 'error');
    }
  }

  // ========== CETAK PDF ==========
  async function cetakPDF() {
    showLoading();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(18);
    doc.text('LAPORAN INVENTARIS SD LAZUARDI', 20, 20);
    doc.setFontSize(11);
    doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 20, 30);
    
    let y = 45;
    barangData.forEach((b, i) => {
      if (y > 280) {
        doc.addPage();
        y = 20;
      }
      doc.text(`${i+1}. ${b.kode} - ${b.nama} | Stok: ${b.jumlah} | ${b.kategori || '-'}`, 20, y);
      y += 7;
    });
    
    doc.save('laporan_inventaris.pdf');
    hideLoading();
    showToast('âœ… PDF berhasil dicetak!', 'success');
  }

  window.onload = cekLogin;
</script>

</body>
</html>
